<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Hetzner-Web 一键部署全记录（Docker 版）</title>
  <style>
    body {
      font-family: "Source Serif Pro", "Noto Serif SC", "STSong", serif;
      line-height: 1.7;
      max-width: 880px;
      margin: 40px auto;
      padding: 0 20px;
      color: #222;
      background: #faf9f7;
    }
    h1, h2, h3 { font-family: "IBM Plex Sans", "Noto Sans SC", sans-serif; }
    pre {
      background: #111;
      color: #f2f2f2;
      padding: 14px 16px;
      overflow-x: auto;
      border-radius: 8px;
      font-size: 14px;
    }
    code { background: #efefef; padding: 2px 6px; border-radius: 4px; }
    pre code { background: none; padding: 0; }
    hr { border: none; border-top: 1px solid #ddd; margin: 24px 0; }
  </style>
</head>
<body>
  <h1>Hetzner-Web 一键部署全记录（Docker 版）</h1>
  <p>本文记录我将 <strong>Hetzner-Web</strong> 推送到 GitHub 之后，如何将部署流程收敛为“一行命令完成安装”的全流程。目标是：任何服务器只需执行一条命令，即可拉起完整服务。</p>

  <hr />

  <h2>项目简介</h2>
  <p>Hetzner-Web 是一个轻量的 Hetzner Cloud 流量控制台，核心功能包括：</p>
  <ul>
    <li>日 / 小时流量统计视图</li>
    <li>流量触顶风险提示</li>
    <li>DNS 检查与重建操作</li>
    <li>清晰的可视化仪表盘</li>
    <li>Basic Auth 登录保护</li>
  </ul>
  <p>技术栈：后端 FastAPI + Python，前端 Vue 3 CDN + 原生 JS/CSS。</p>

  <h2>部署目标</h2>
  <p>将原本需要多步执行的操作，压缩成“一条命令”。理想流程：</p>
  <ol>
    <li>自动拉取仓库代码</li>
    <li>自动生成配置文件</li>
    <li>自动 Docker 编译并启动</li>
  </ol>

  <h2>服务器环境准备</h2>
  <p>推荐环境：</p>
  <ul>
    <li>Linux（Ubuntu / Debian / CentOS 均可）</li>
    <li>Docker</li>
    <li>Docker Compose</li>
    <li>Git</li>
  </ul>

  <p>如果是新机器，可快速安装 Docker：</p>
  <pre><code>curl -fsSL https://get.docker.com | bash</code></pre>

  <h2>一键安装脚本设计</h2>
  <p>为简化部署，我在仓库新增脚本：</p>
  <pre><code>scripts/install-docker.sh</code></pre>
  <p>脚本逻辑：</p>
  <ol>
    <li>clone / pull 仓库</li>
    <li>生成配置文件（config.yaml / web_config.json / report_state.json）</li>
    <li>docker compose up -d --build</li>
  </ol>

  <h2>一键安装命令</h2>
  <pre><code>curl -fsSL https://raw.githubusercontent.com/liuweiqiang0523/Hetzner-Web/main/scripts/install-docker.sh | bash</code></pre>

  <p>可选自定义安装目录：</p>
  <pre><code>curl -fsSL https://raw.githubusercontent.com/liuweiqiang0523/Hetzner-Web/main/scripts/install-docker.sh | INSTALL_DIR=/srv/hetzner-web bash</code></pre>

  <p>可用环境变量：</p>
  <ul>
    <li><code>INSTALL_DIR</code>：安装目录（默认 /opt/hetzner-web）</li>
    <li><code>BRANCH</code>：分支（默认 main）</li>
    <li><code>REPO_URL</code>：仓库地址</li>
  </ul>

  <h2>配置文件说明</h2>
  <p>脚本会自动生成：</p>
  <ul>
    <li><code>config.yaml</code></li>
    <li><code>web_config.json</code></li>
    <li><code>report_state.json</code></li>
  </ul>

  <h3>config.yaml</h3>
  <p>关键字段：</p>
  <ul>
    <li><code>hetzner.api_token</code>（必填）</li>
    <li><code>traffic.limit_gb</code></li>
    <li><code>cloudflare.record_map</code>（可选）</li>
    <li><code>cloudflare.update_retries</code> / <code>cloudflare.update_retry_delay</code> / <code>cloudflare.rebuild_sync_delay_seconds</code>（可选）</li>
    <li><code>rebuild.snapshot_id_map</code>（可选）</li>
    <li><code>qbittorrent.rebuild_cooldown_seconds</code>（可选）</li>
    <li><code>qbittorrent.instances[].login_retries</code> / <code>qbittorrent.instances[].login_retry_delay</code>（可选）</li>
    <li><code>report_state.json</code> 每日备份到 <code>report_state_backups/</code>（保留最近 3 份）</li>
  </ul>

  <h3>web_config.json</h3>
  <ul>
    <li><code>username</code></li>
    <li><code>password</code></li>
    <li><code>tracking_start</code>（可选）</li>
  </ul>

  <h2>启动与访问</h2>
  <p>脚本执行完后，容器已自动启动：</p>
  <pre><code>docker compose up -d --build</code></pre>

  <p>访问地址：</p>
  <pre><code>http://&lt;server-ip&gt;:1227</code></pre>

  <h2>Nginx 反向代理（推荐）</h2>
  <p>线上建议配 HTTPS + 反向代理：</p>
  <pre><code>server {
  listen 443 ssl;
  server_name hz.example.com;

  ssl_certificate /path/to/fullchain.pem;
  ssl_certificate_key /path/to/privkey.pem;

  location / {
    proxy_pass http://127.0.0.1:1227;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}</code></pre>

  <h2>更新方式</h2>
  <p>版本更新只需重新执行一键脚本：</p>
  <pre><code>curl -fsSL https://raw.githubusercontent.com/liuweiqiang0523/Hetzner-Web/main/scripts/install-docker.sh | bash</code></pre>
  <p>脚本会自动检测并执行 git pull。</p>

  <h2>总结</h2>
  <p>这次部署的核心是把“手动流程”标准化为“一键脚本”，优势是：</p>
  <ul>
    <li>部署成本低</li>
    <li>重复部署方便</li>
    <li>适合多台机器批量使用</li>
  </ul>

  <p>后续可继续扩展脚本，比如：自动 HTTPS、systemd 守护、监控报警等。</p>
</body>
</html>
